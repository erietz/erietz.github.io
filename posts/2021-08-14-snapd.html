<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Snapcraft sucks</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #665c54;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #665c54;  padding-left: 4px; }
    div.sourceCode
      { color: #ededed; background-color: #282828; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ffffb3; font-weight: bold; } /* Alert */
    code span.an { color: #80b1d3; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #b3de69; } /* Attribute */
    code span.bn { color: #bebada; } /* BaseN */
    code span.bu { color: #fdb462; } /* BuiltIn */
    code span.cf { color: #fb8072; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #b3de69; } /* Char */
    code span.cn { color: #ffffb3; } /* Constant */
    code span.co { color: #80b1d3; font-style: italic; } /* Comment */
    code span.cv { color: #80b1d3; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #ffffb3; } /* DataType */
    code span.dv { color: #bebada; } /* DecVal */
    code span.er { color: #ffffb3; font-weight: bold; } /* Error */
    code span.ex { color: #fdb462; } /* Extension */
    code span.fl { color: #bebada; } /* Float */
    code span.fu { color: #b3de69; } /* Function */
    code span.im { color: #fb8072; } /* Import */
    code span.in { color: #80b1d3; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #fb8072; font-weight: bold; } /* Keyword */
    code span.op { color: #ededed; } /* Operator */
    code span.ot { color: #fb8072; } /* Other */
    code span.pp { color: #80b1d3; } /* Preprocessor */
    code span.sc { color: #b3de69; } /* SpecialChar */
    code span.ss { color: #8dd3c7; } /* SpecialString */
    code span.st { color: #8dd3c7; } /* String */
    code span.va { color: #bebada; } /* Variable */
    code span.vs { color: #8dd3c7; } /* VerbatimString */
    code span.wa { color: #80b1d3; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="/assets/css/master.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<script src="/assets/js/navigation.js" charset="utf-8"></script>
<header id="title-block-header">
<h1 class="title">Snapcraft sucks</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#tldr" id="toc-tldr">tl;dr</a></li>
<li><a href="#snap-broke-my-filesystem"
id="toc-snap-broke-my-filesystem">Snap broke my filesystem</a></li>
<li><a href="#solution" id="toc-solution">Solution</a></li>
</ul>
</nav>
<h2 id="tldr">tl;dr</h2>
<p>Don’t use snap.</p>
<h2 id="snap-broke-my-filesystem">Snap broke my filesystem</h2>
<p>I few months ago I was unable to open discord on my laptop because
the package needed updated. Unfortunately, updating the package using
<code>pacman</code> led to the same problem since the version in
Manjaro’s repositories was also out of date.</p>
<p>I am ashamed to admit that I installed <a
href="https://snapcraft.io/">snapd</a> and proceeded to run a
<code>snap install discord</code>.</p>
<p>Today I was successfully able to install discord using
<code>pacman</code> and decided to remove the version that I had
installed using snap. I tried some series of
<code>snap remove discord</code>,
<code>snap remove --purge discord</code> but was met with a series of
errors. So I tried the brute force way and issued a
<code>sudo rm -rf ~/snap/</code> which resulted in the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">rm:</span> cannot remove <span class="st">&#39;snap/discord/122/.config/discord/Cache/426b6c378616834c_0&#39;</span>: Structure needs cleaning</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">rm:</span> cannot remove <span class="st">&#39;snap/discord/122/.config/discord/Cache/edf3e64c37bbcba6_0&#39;</span>: Bad message</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
<p>After consulting the internet, I discovered that
<code>Structure needs cleaning</code> is a strong indication that your
file system is corrupt. Yep, indeed, the file system had been corrupted.
I wasn’t even able to do an <code>ls</code> in that directory without
the shell complaining.</p>
<p>I thought that perhaps the SSD was going bad since the computer was
made in 2012. However, it turned out that repairing the disk was all
that needed to be done. The SSD is still kicking.</p>
<h2 id="solution">Solution</h2>
<p>Luckily, I still had my bootable USB lying around with the manjaro
installation, so I was able to boot into the machine and run
<code>fsck</code> on the unmounted root partition. To make things more
difficult on myself, the hard drive is encrypted with <a
href="https://wiki.archlinux.org/title/dm-crypt/Device_encryption#Cryptsetup_usage">LUKS</a>,
so I had to first “create a device mapper” for the encrypted drive at
<code>/dev/sda2</code>. Running
<code>cryptsetup luksOpen /dev/sda2 foo</code> and entering the password
for the disk opened the device at <code>/dev/mapper/foo</code>. Then I
was able to run <code>fsck</code> on the opened device,
<code>fsck /dev/mapper/foo</code>, and repair the file system.</p>
<p>After booting back into the system, I was able to run
<code>sudo rm -rf ~/snap</code> and <code>sudo pacman -Rs snapd</code>.
The moral of the story is that snaps a joke and you should just use the
package manager.</p>
<script src="/assets/js/footer.js" charset="utf-8"></script>
<hr>
<script src="https://utteranc.es/client.js"
        repo="erietz/erietz.github.io"
        issue-term="pathname"
        theme="photon-dark"
        crossorigin="anonymous"
        async>
</script>
<hr>
</body>
</html>
